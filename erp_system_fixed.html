<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema ERP com Login</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* Login Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-box h2 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .login-subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .error-message {
            color: #ef4444;
            font-size: 14px;
            margin-top: 15px;
            padding: 12px;
            background: #fee;
            border-radius: 8px;
            border-left: 4px solid #ef4444;
            display: none;
        }

        .error-message.show {
            display: block;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .login-info {
            margin-top: 20px;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .login-info p {
            font-size: 13px;
            color: #1e40af;
            margin: 5px 0;
        }

        /* ERP System Styles */
        #erpSystem {
            display: none;
            background: #f4f4f4;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo {
            background: white;
            color: #667eea;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: bold;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 8px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ef4444;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #10b981;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            background: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            color: #666;
        }

        .tab:hover {
            background: #f0f0f0;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.2);
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 12px;
            font-size: 12px;
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #fbbf24;
        }

        .sync-indicator.synced {
            background: #10b981;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        table thead {
            background: #f9fafb;
        }

        table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            font-size: 13px;
        }

        table td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            color: #6b7280;
            font-size: 14px;
        }

        table tr:hover {
            background: #f9fafb;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-bar input {
            flex: 1;
            min-width: 200px;
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        .scanner-container {
            background: #111;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        #video {
            width: 100%;
            max-width: 640px;
            border-radius: 8px;
            display: block;
            margin: 0 auto 20px;
        }

        .scanner-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .scanner-controls label {
            color: white;
            font-weight: 500;
        }

        .scanner-controls input,
        .scanner-controls select {
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
        }

        .offline-entry {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .offline-entry h3 {
            margin-bottom: 10px;
            color: #374151;
        }

        #scannerLog {
            background: #1f2937;
            color: #10b981;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            header h1 {
                font-size: 18px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            table th, table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h2>🔐 Sistema ERP</h2>
            <p class="login-subtitle">Gestão de Estoque Integrado</p>
            
            <form id="loginForm" onsubmit="return handleLogin(event)">
                <div class="form-group">
                    <label for="username">Usuário</label>
                    <input type="text" id="username" placeholder="Digite seu usuário" required autofocus />
                </div>
                
                <div class="form-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" placeholder="Digite sua senha" required />
                </div>
                
                <button type="submit" class="login-btn">Entrar no Sistema</button>
                
                <div class="error-message" id="errorMessage"></div>
            </form>
            
            <div class="login-info" style="display:none;">
                <p><strong>💡 Credenciais de teste:</strong></p>
                <p>Usuário: <strong>admin</strong></p>
                <p>Senha: <strong>admin123</strong></p>
            </div>
        </div>
    </div>

    <!-- ERP System (hidden by default) -->
    <div id="erpSystem">
        <div class="container">
            <header>
                <h1>
                    <div class="logo">ERP</div>
                    Sistema de Gestão de Estoque Integrado
                </h1>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div class="connection-status">
                        <div class="status-indicator" id="connectionStatus"></div>
                        <span id="connectionText">Conectando...</span>
                    </div>
                    <span id="currentTime"></span>
                </div>
            </header>

            <div class="nav-tabs">
                <button class="tab active" onclick="switchTab('dashboard')">📊 Dashboard</button>
                <button class="tab" onclick="switchTab('products')">📦 Produtos</button>
                <button class="tab" onclick="switchTab('movements')">🔄 Movimentações</button>
                <button class="tab" onclick="switchTab('scanner')">📱 Scanner</button>
                <button class="tab" onclick="switchTab('reports')">📈 Relatórios</button>
            </div>

            <div class="content">
                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-content active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalProducts">0</div>
                            <div class="stat-label">Total de Produtos</div>
                            <div class="sync-status">
                                <div class="sync-indicator synced"></div>
                                <span>Sincronizado</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalStock">0</div>
                            <div class="stat-label">Itens em Estoque</div>
                            <div class="sync-status">
                                <div class="sync-indicator synced"></div>
                                <span>Atualizado</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalValue">R$ 0</div>
                            <div class="stat-label">Valor Total</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="todayMovements">0</div>
                            <div class="stat-label">Movimentações Hoje</div>
                            <div class="sync-status">
                                <div class="sync-indicator synced"></div>
                                <span>Tempo real</span>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <h2>📊 Produtos com Estoque Baixo</h2>
                        <table id="lowStockTable">
                            <thead>
                                <tr>
                                    <th>SKU</th>
                                    <th>Produto</th>
                                    <th>Quantidade</th>
                                    <th>Status</th>
                                    <th>Ação</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <div class="section">
                        <h2>📈 Últimas Movimentações</h2>
                        <table id="recentMovements">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Produto</th>
                                    <th>Tipo</th>
                                    <th>Quantidade</th>
                                    <th>Origem</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Products Tab -->
                <div id="products" class="tab-content">
                    <div class="section">
                        <h2>➕ Cadastrar Produto</h2>
                        <form id="productForm" class="form-grid">
                            <div class="form-group">
                                <label>SKU/Código de Barras</label>
                                <input type="text" id="sku" placeholder="Ex: 7891234567890" required>
                            </div>
                            <div class="form-group">
                                <label>Nome</label>
                                <input type="text" id="name" placeholder="Nome do produto" required>
                            </div>
                            <div class="form-group">
                                <label>Quantidade Inicial</label>
                                <input type="number" id="quantity" placeholder="0" min="0" required>
                            </div>
                            <div class="form-group">
                                <label>Preço (R$)</label>
                                <input type="number" id="price" placeholder="0.00" step="0.01" min="0" required>
                            </div>
                            <div class="form-group">
                                <label>Fornecedor</label>
                                <input type="text" id="supplier" placeholder="Nome do fornecedor">
                            </div>
                            <div class="form-group">
                                <label>Estoque Mínimo</label>
                                <input type="number" id="minStock" placeholder="10" min="0">
                            </div>
                            <div class="form-group" style="align-self: flex-end;">
                                <button type="submit">➕ Cadastrar Produto</button>
                            </div>
                        </form>
                    </div>

                    <div class="section">
                        <h2>📦 Lista de Produtos</h2>
                        <div class="search-bar">
                            <input type="text" id="searchProduct" placeholder="Buscar por nome ou SKU..." oninput="searchProducts()">
                            <button onclick="exportProducts()">📥 Exportar</button>
                        </div>
                        <table id="productsTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>SKU</th>
                                    <th>Nome</th>
                                    <th>Quantidade</th>
                                    <th>Preço</th>
                                    <th>Valor Total</th>
                                    <th>Fornecedor</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Movements Tab -->
                <div id="movements" class="tab-content">
                    <div class="section">
                        <h2>🔄 Registrar Movimentação</h2>
                        <form id="movementForm" class="form-grid">
                            <div class="form-group">
                                <label>Produto</label>
                                <select id="movProductId" required>
                                    <option value="">Selecione um produto</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Tipo</label>
                                <select id="movType" required>
                                    <option value="entrada">Entrada</option>
                                    <option value="saida">Saída</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Quantidade</label>
                                <input type="number" id="movQuantity" min="1" required>
                            </div>
                            <div class="form-group">
                                <label>Responsável</label>
                                <input type="text" id="movUser" placeholder="Nome do responsável" required>
                            </div>
                            <div class="form-group">
                                <label>Observações</label>
                                <input type="text" id="movNotes" placeholder="Observações (opcional)">
                            </div>
                            <div class="form-group" style="align-self: flex-end;">
                                <button type="submit" class="btn-success">✓ Registrar Movimentação</button>
                            </div>
                        </form>
                    </div>

                    <div class="section">
                        <h2>📋 Histórico de Movimentações</h2>
                        <div class="search-bar">
                            <input type="date" id="startDate">
                            <input type="date" id="endDate">
                            <button onclick="filterMovements()">🔍 Filtrar</button>
                            <button onclick="clearFilter()">❌ Limpar</button>
                        </div>
                        <table id="movementsTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Data/Hora</th>
                                    <th>Produto</th>
                                    <th>Tipo</th>
                                    <th>Quantidade</th>
                                    <th>Responsável</th>
                                    <th>Origem</th>
                                    <th>Observações</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Scanner Tab -->
                <div id="scanner" class="tab-content">
                    <div class="section">
                        <h2>📱 Scanner de Código de Barras</h2>
                        
                        <div class="scanner-container">
                            <video id="video" playsinline autoplay muted></video>
                            
                            <div class="scanner-controls">
                                <label for="scanType">Tipo:</label>
                                <select id="scanType">
                                    <option value="entrada">Entrada</option>
                                    <option value="saida">Saída</option>
                                </select>
                                
                                <label for="scanQuantity">Qtd:</label>
                                <input type="number" id="scanQuantity" value="1" min="1" style="width: 80px;">
                                
                                <label for="scanUser">Responsável:</label>
                                <input type="text" id="scanUser" placeholder="Seu nome" required style="min-width: 150px;">
                                
                                <button id="startCamera" onclick="startCamera()">🎥 Iniciar</button>
                                <button id="stopCamera" onclick="stopCamera()" disabled>⏹️ Parar</button>
                            </div>
                        </div>

                        <div class="offline-entry">
                            <h3>Entrada Manual de Código</h3>
                            <p>Caso a câmera não funcione, digite o código manualmente:</p>
                            <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                                <input type="text" id="manualCode" placeholder="Digite o código de barras" style="flex: 1; min-width: 200px;">
                                <button onclick="processManualCode()" class="btn-success">Processar Código</button>
                            </div>
                        </div>

                        <div id="scannerLog">Sistema de scanner inicializado.</div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div id="reports" class="tab-content">
                    <div class="section">
                        <h2>📈 Relatórios e Análises</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="monthlyIn">0</div>
                                <div class="stat-label">Entradas no Mês</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="monthlyOut">0</div>
                                <div class="stat-label">Saídas no Mês</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="turnoverRate">0%</div>
                                <div class="stat-label">Taxa de Giro</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="avgStockValue">R$ 0</div>
                                <div class="stat-label">Valor Médio Estoque</div>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <h2>📊 Produtos Mais Movimentados</h2>
                        <table id="topProductsTable">
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Total Movimentações</th>
                                    <th>Entradas</th>
                                    <th>Saídas</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let products = [];
        let movements = [];
        let stream = null;
        let detecting = false;
        let lastScannedCode = null;
        let scanTimeout = null;

        // Login Handler
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');

            if (username === "" || password === "") {
                errorMessage.textContent = "Por favor, preencha todos os campos.";
                errorMessage.classList.add('show');
                return false;
            }

            const hashedPassword = sha256(password);

            if (username === "admin" && hashedPassword === sha256("admin123")) {
                document.getElementById("loginPage").style.display = "none";
                document.getElementById("erpSystem").style.display = "block";
                initializeSystem();
            } else {
                errorMessage.textContent = "Usuário ou senha incorretos.";
                errorMessage.classList.add('show');
            }
            return false;
        }

        // Initialize System
        function initializeSystem() {
            loadSampleData();
            updateDashboard();
            updateClock();
            setInterval(updateClock, 1000);
            log('Sistema iniciado com sucesso');
        }

        // Load Sample Data
        function loadSampleData() {
            products = [
                { id: 1, sku: '7891234567890', name: 'Rojão Trovão Colorido', quantity: 150, price: 12.50, supplier: 'Fogos São João', minStock: 20 },
                { id: 2, sku: '7891234567891', name: 'Morteiro 3 Polegadas', quantity: 45, price: 85.00, supplier: 'Pirotecnia Brasil', minStock: 10 },
                { id: 3, sku: '7891234567892', name: 'Chuva de Prata', quantity: 8, price: 65.00, supplier: 'Fogos Minas', minStock: 5 },
                { id: 4, sku: '7891234567893', name: 'Bomba Coração Apaixonado', quantity: 22, price: 35.00, supplier: 'Pirotecnia Brasil', minStock: 8 },
                { id: 5, sku: '7891234567894', name: 'Cascata Dourada', quantity: 12, price: 45.00, supplier: 'Fogos São João', minStock: 6 }
            ];

            const now = new Date();
            movements = [
                { id: 1, productId: 1, type: 'ENTRADA', quantity: 50, user: 'João Silva', date: new Date(now - 86400000), notes: 'Estoque inicial', origin: 'manual' },
                { id: 2, productId: 2, type: 'SAIDA', quantity: 5, user: 'Maria Santos', date: new Date(now - 43200000), notes: 'Venda casamento', origin: 'manual' },
                { id: 3, productId: 3, type: 'ENTRADA', quantity: 20, user: 'Pedro Costa', date: new Date(now - 3600000), notes: 'Reposição estoque', origin: 'manual' }
            ];

            updateAllTables();
        }

        // Update Clock
        function updateClock() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleString('pt-BR');
            document.getElementById('connectionStatus').classList.add('connected');
            document.getElementById('connectionText').textContent = 'Online';
        }

        // Switch Tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'dashboard') updateDashboard();
            if (tabName === 'products') updateProductsTable();
            if (tabName === 'movements') updateMovementsTable();
            if (tabName === 'reports') updateReports();
            if (tabName === 'scanner') initializeScanner();
        }

        // Dashboard Functions
        function updateDashboard() {
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('totalStock').textContent = products.reduce((sum, p) => sum + p.quantity, 0);
            
            const totalValue = products.reduce((sum, p) => sum + (p.quantity * p.price), 0);
            document.getElementById('totalValue').textContent = formatCurrency(totalValue);
            
            const today = new Date().toDateString();
            const todayMovs = movements.filter(m => m.date.toDateString() === today).length;
            document.getElementById('todayMovements').textContent = todayMovs;

            updateLowStockTable();
            updateRecentMovementsTable();
        }

        function updateLowStockTable() {
            const lowStock = products.filter(p => p.quantity <= (p.minStock || 10));
            const tbody = document.querySelector('#lowStockTable tbody');
            tbody.innerHTML = '';
            
            if (lowStock.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #9ca3af;">Nenhum produto com estoque baixo</td></tr>';
            } else {
                lowStock.forEach(product => {
                    const status = product.quantity === 0 ? 'danger' : product.quantity < 5 ? 'warning' : 'success';
                    tbody.innerHTML += `
                        <tr>
                            <td>${product.sku}</td>
                            <td>${product.name}</td>
                            <td>${product.quantity}</td>
                            <td><span class="badge badge-${status}">${getStatusLabel(product.quantity)}</span></td>
                            <td><button onclick="quickRestock(${product.id})" class="btn-success" style="padding: 4px 8px; font-size: 12px;">Repor</button></td>
                        </tr>
                    `;
                });
            }
        }

        function updateRecentMovementsTable() {
            const recentMovs = movements.slice(-10).reverse();
            const tbody = document.querySelector('#recentMovements tbody');
            tbody.innerHTML = '';
            
            if (recentMovs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #9ca3af;">Nenhuma movimentação registrada</td></tr>';
            } else {
                recentMovs.forEach(mov => {
                    const product = products.find(p => p.id === mov.productId);
                    const typeClass = mov.type === 'ENTRADA' ? 'success' : 'danger';
                    const originBadge = mov.origin === 'scanner' ? 
                        '<span class="badge badge-success">Scanner</span>' : 
                        '<span class="badge badge-warning">Manual</span>';
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${formatDateTime(mov.date)}</td>
                            <td>${product ? product.name : 'Produto removido'}</td>
                            <td><span class="badge badge-${typeClass}">${mov.type}</span></td>
                            <td>${mov.quantity}</td>
                            <td>${originBadge}</td>
                            <td><span class="badge badge-success">Sincronizado</span></td>
                        </tr>
                    `;
                });
            }
        }

        // Products Functions
        function updateProductsTable() {
            const tbody = document.querySelector('#productsTable tbody');
            tbody.innerHTML = '';

            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #9ca3af;">Nenhum produto cadastrado</td></tr>';
                return;
            }

            products.forEach(product => {
                const totalValue = product.quantity * product.price;
                
                tbody.innerHTML += `
                    <tr>
                        <td>${product.id}</td>
                        <td>${product.sku}</td>
                        <td>${product.name}</td>
                        <td>${product.quantity}</td>
                        <td>${formatCurrency(product.price)}</td>
                        <td>${formatCurrency(totalValue)}</td>
                        <td>${product.supplier || '-'}</td>
                        <td>
                            <div class="action-buttons">
                                <button onclick="editProduct(${product.id})" style="padding: 6px 12px; font-size: 12px;">✏️ Editar</button>
                                <button onclick="deleteProduct(${product.id})" class="btn-danger" style="padding: 6px 12px; font-size: 12px;">🗑️ Excluir</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            updateMovementSelects();
        }

        function updateMovementsTable() {
            const tbody = document.querySelector('#movementsTable tbody');
            tbody.innerHTML = '';

            if (movements.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #9ca3af;">Nenhuma movimentação registrada</td></tr>';
                return;
            }

            movements.slice().reverse().forEach(mov => {
                const product = products.find(p => p.id === mov.productId);
                const typeClass = mov.type === 'ENTRADA' ? 'success' : 'danger';
                const originBadge = mov.origin === 'scanner' ? 
                    '<span class="badge badge-success">Scanner</span>' : 
                    '<span class="badge badge-warning">Manual</span>';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${mov.id}</td>
                        <td>${formatDateTime(mov.date)}</td>
                        <td>${product ? product.name : 'Produto removido'}</td>
                        <td><span class="badge badge-${typeClass}">${mov.type}</span></td>
                        <td>${mov.quantity}</td>
                        <td>${mov.user}</td>
                        <td>${originBadge}</td>
                        <td>${mov.notes || '-'}</td>
                    </tr>
                `;
            });
        }

        function updateMovementSelects() {
            const select = document.getElementById('movProductId');
            select.innerHTML = '<option value="">Selecione um produto</option>';
            
            products.forEach(product => {
                select.innerHTML += `<option value="${product.id}">${product.name} (${product.sku})</option>`;
            });
        }

        function updateAllTables() {
            updateProductsTable();
            updateMovementsTable();
            updateDashboard();
        }

        // Form Handlers
        document.addEventListener('DOMContentLoaded', function() {
            const productForm = document.getElementById('productForm');
            if (productForm) {
                productForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const newProduct = {
                        id: products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1,
                        sku: document.getElementById('sku').value,
                        name: document.getElementById('name').value,
                        quantity: parseInt(document.getElementById('quantity').value),
                        price: parseFloat(document.getElementById('price').value),
                        supplier: document.getElementById('supplier').value,
                        minStock: parseInt(document.getElementById('minStock').value) || 10
                    };

                    if (products.some(p => p.sku === newProduct.sku)) {
                        showAlert('SKU já existe! Use um código diferente.', 'danger');
                        return;
                    }

                    products.push(newProduct);
                    this.reset();
                    updateAllTables();
                    showAlert('Produto cadastrado com sucesso!', 'success');
                });
            }

            const movementForm = document.getElementById('movementForm');
            if (movementForm) {
                movementForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const productId = parseInt(document.getElementById('movProductId').value);
                    const type = document.getElementById('movType').value.toUpperCase();
                    const quantity = parseInt(document.getElementById('movQuantity').value);
                    const product = products.find(p => p.id === productId);

                    if (!product) {
                        showAlert('Produto não encontrado!', 'danger');
                        return;
                    }

                    if (type === 'SAIDA' && product.quantity < quantity) {
                        showAlert('Estoque insuficiente!', 'danger');
                        return;
                    }

                    const newMovement = {
                        id: movements.length > 0 ? Math.max(...movements.map(m => m.id)) + 1 : 1,
                        productId: productId,
                        type: type,
                        quantity: quantity,
                        user: document.getElementById('movUser').value,
                        date: new Date(),
                        notes: document.getElementById('movNotes').value,
                        origin: 'manual'
                    };

                    if (type === 'ENTRADA') {
                        product.quantity += quantity;
                    } else {
                        product.quantity -= quantity;
                    }

                    movements.push(newMovement);
                    this.reset();
                    updateAllTables();
                    showAlert('Movimentação registrada com sucesso!', 'success');
                });
            }
        });

        // Scanner Functions
        function initializeScanner() {
            log('Sistema de scanner inicializado.');
        }

        function startCamera() {
            const scanUser = document.getElementById('scanUser').value.trim();
            if (!scanUser) {
                showAlert('Por favor, preencha o campo "Responsável" antes de iniciar o scanner.', 'warning');
                return;
            }

            navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' }, 
                audio: false 
            })
            .then(function(s) {
                stream = s;
                const video = document.getElementById('video');
                video.srcObject = stream;
                video.play();
                
                document.getElementById('startCamera').disabled = true;
                document.getElementById('stopCamera').disabled = false;
                detecting = true;
                
                log('Câmera iniciada. Aguardando detecção de código...');
                showAlert('Câmera ativada! Aponte para o código de barras.', 'success');
            })
            .catch(function(err) {
                console.error('Erro ao iniciar câmera:', err);
                log('Erro ao acessar câmera: ' + err.message);
                showAlert('Erro ao acessar câmera. Use a entrada manual.', 'danger');
            });
        }

        function stopCamera() {
            detecting = false;
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                const video = document.getElementById('video');
                video.srcObject = null;
                stream = null;
            }

            document.getElementById('startCamera').disabled = false;
            document.getElementById('stopCamera').disabled = true;
            
            log('Câmera desligada.');
        }

        function processManualCode() {
            const code = document.getElementById('manualCode').value.trim();
            
            if (!code) {
                showAlert('Digite um código de barras válido.', 'warning');
                return;
            }
            
            const user = document.getElementById('scanUser').value.trim();
            if (!user) {
                showAlert('Por favor, preencha o campo "Responsável".', 'warning');
                return;
            }
            
            log(`Processando código manual: ${code}`);
            processScannedCode(code);
            
            document.getElementById('manualCode').value = '';
        }

        function processScannedCode(code) {
            const scanType = document.getElementById('scanType').value.toUpperCase();
            const quantity = parseInt(document.getElementById('scanQuantity').value) || 1;
            const user = document.getElementById('scanUser').value.trim();
            
            const product = products.find(p => p.sku === code);
            
            if (!product) {
                log(`Produto não encontrado: ${code}`);
                showAlert(`Produto não encontrado: ${code}`, 'warning');
                return;
            }
            
            if (scanType === 'SAIDA' && product.quantity < quantity) {
                log(`Estoque insuficiente: ${product.name}`);
                showAlert(`Estoque insuficiente: ${product.name}`, 'danger');
                return;
            }
            
            const newMovement = {
                id: movements.length > 0 ? Math.max(...movements.map(m => m.id)) + 1 : 1,
                productId: product.id,
                type: scanType,
                quantity: quantity,
                user: user,
                date: new Date(),
                notes: `Scanner - Código: ${code}`,
                origin: 'scanner'
            };
            
            if (scanType === 'ENTRADA') {
                product.quantity += quantity;
                log(`Entrada: +${quantity} ${product.name}. Estoque: ${product.quantity}`);
            } else {
                product.quantity -= quantity;
                log(`Saída: -${quantity} ${product.name}. Estoque: ${product.quantity}`);
            }
            
            movements.push(newMovement);
            updateAllTables();
            
            const typeText = scanType === 'ENTRADA' ? 'Entrada' : 'Saída';
            showAlert(`${typeText} registrada! ${product.name} - Qtd: ${quantity}`, 'success');
        }

        // Reports Functions
        function updateReports() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const monthlyMovements = movements.filter(m => 
                m.date.getMonth() === currentMonth && m.date.getFullYear() === currentYear
            );

            const monthlyIn = monthlyMovements.filter(m => m.type === 'ENTRADA')
                .reduce((sum, m) => sum + m.quantity, 0);
            const monthlyOut = monthlyMovements.filter(m => m.type === 'SAIDA')
                .reduce((sum, m) => sum + m.quantity, 0);

            document.getElementById('monthlyIn').textContent = monthlyIn;
            document.getElementById('monthlyOut').textContent = monthlyOut;

            const totalStock = products.reduce((sum, p) => sum + p.quantity, 0);
            const turnover = totalStock > 0 ? ((monthlyOut / totalStock) * 100).toFixed(1) : 0;
            document.getElementById('turnoverRate').textContent = turnover + '%';

            const avgValue = products.length > 0 ? 
                products.reduce((sum, p) => sum + (p.quantity * p.price), 0) / products.length : 0;
            document.getElementById('avgStockValue').textContent = formatCurrency(avgValue);

            updateTopProducts();
        }

        function updateTopProducts() {
            const productMovements = {};
            
            movements.forEach(mov => {
                if (!productMovements[mov.productId]) {
                    productMovements[mov.productId] = { in: 0, out: 0, total: 0 };
                }
                
                const isIn = mov.type === 'ENTRADA';
                productMovements[mov.productId][isIn ? 'in' : 'out'] += mov.quantity;
                productMovements[mov.productId].total += mov.quantity;
            });

            const topProducts = Object.entries(productMovements)
                .map(([productId, stats]) => {
                    const product = products.find(p => p.id == productId);
                    return {
                        product: product ? product.name : 'Produto removido',
                        ...stats
                    };
                })
                .sort((a, b) => b.total - a.total)
                .slice(0, 10);

            const tbody = document.querySelector('#topProductsTable tbody');
            tbody.innerHTML = '';

            if (topProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #9ca3af;">Nenhuma movimentação registrada</td></tr>';
            } else {
                topProducts.forEach(item => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${item.product}</td>
                            <td>${item.total}</td>
                            <td>${item.in}</td>
                            <td>${item.out}</td>
                        </tr>
                    `;
                });
            }
        }

        // Utility Functions
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function formatDateTime(date) {
            return new Intl.DateTimeFormat('pt-BR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).format(date);
        }

        function getStatusLabel(quantity) {
            if (quantity === 0) return 'Sem Estoque';
            if (quantity < 5) return 'Estoque Crítico';
            if (quantity < 10) return 'Estoque Baixo';
            return 'OK';
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <span>${type === 'success' ? '✓' : type === 'warning' ? '⚠️' : '❌'}</span>
                ${message}
            `;
            
            document.querySelector('.content').insertBefore(alertDiv, document.querySelector('.content').firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        function log(message) {
            const logEl = document.getElementById('scannerLog');
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            const logMessage = `[${timestamp}] ${message}\n`;
            logEl.textContent = logMessage + logEl.textContent;
            
            const lines = logEl.textContent.split('\n');
            if (lines.length > 50) {
                logEl.textContent = lines.slice(0, 50).join('\n');
            }
        }

        function quickRestock(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const quantity = prompt(`Quantidade para reposição de ${product.name}:`, product.minStock);
            if (quantity && !isNaN(quantity) && quantity > 0) {
                const newMovement = {
                    id: movements.length > 0 ? Math.max(...movements.map(m => m.id)) + 1 : 1,
                    productId: product.id,
                    type: 'ENTRADA',
                    quantity: parseInt(quantity),
                    user: 'Sistema',
                    date: new Date(),
                    notes: 'Reposição rápida',
                    origin: 'manual'
                };

                product.quantity += parseInt(quantity);
                movements.push(newMovement);
                updateAllTables();
                
                showAlert(`Reposição registrada: +${quantity} ${product.name}`, 'success');
            }
        }

        function searchProducts() {
            const search = document.getElementById('searchProduct').value.toLowerCase();
            const rows = document.querySelectorAll('#productsTable tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function filterMovements() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                showAlert('Selecione as datas de início e fim', 'warning');
                return;
            }

            const filteredMovements = movements.filter(mov => {
                const movDate = mov.date.toISOString().split('T')[0];
                return movDate >= startDate && movDate <= endDate;
            });

            updateMovementsTableWithData(filteredMovements);
        }

        function clearFilter() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            updateMovementsTable();
        }

        function updateMovementsTableWithData(data) {
            const tbody = document.querySelector('#movementsTable tbody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #9ca3af;">Nenhuma movimentação encontrada</td></tr>';
                return;
            }

            data.slice().reverse().forEach(mov => {
                const product = products.find(p => p.id === mov.productId);
                const typeClass = mov.type === 'ENTRADA' ? 'success' : 'danger';
                const originBadge = mov.origin === 'scanner' ? 
                    '<span class="badge badge-success">Scanner</span>' : 
                    '<span class="badge badge-warning">Manual</span>';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${mov.id}</td>
                        <td>${formatDateTime(mov.date)}</td>
                        <td>${product ? product.name : 'Produto removido'}</td>
                        <td><span class="badge badge-${typeClass}">${mov.type}</span></td>
                        <td>${mov.quantity}</td>
                        <td>${mov.user}</td>
                        <td>${originBadge}</td>
                        <td>${mov.notes || '-'}</td>
                    </tr>
                `;
            });
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            const newName = prompt(`Editar nome do produto (${product.sku}):`, product.name);
            if (newName && newName !== product.name) {
                product.name = newName;
                updateAllTables();
                showAlert('Produto atualizado!', 'success');
            }
        }

        function deleteProduct(id) {
            if (confirm('Tem certeza que deseja excluir este produto?')) {
                const productIndex = products.findIndex(p => p.id === id);
                if (productIndex !== -1) {
                    movements = movements.filter(m => m.productId !== id);
                    products.splice(productIndex, 1);
                    updateAllTables();
                    showAlert('Produto excluído!', 'success');
                }
            }
        }

        function exportProducts() {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "ID,SKU,Nome,Quantidade,Preço,Fornecedor,Estoque Mínimo\n" +
                products.map(p => 
                    `${p.id},"${p.sku}","${p.name}",${p.quantity},${p.price},"${p.supplier || ''}",${p.minStock}`
                ).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `produtos_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('Produtos exportados com sucesso!', 'success');
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && detecting) {
                stopCamera();
            }
            
            if (e.key === 'Enter' && e.target.id === 'manualCode') {
                processManualCode();
            }
        });

        // Cleanup
        window.addEventListener('beforeunload', function() {
            if (detecting) {
                stopCamera();
            }
        });
    </script>