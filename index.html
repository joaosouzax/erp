const express = require("express");
const http = require("http");
const { Server } = require("socket.io");

const app = express();
const server = http.createServer(app);
const io = new Server(server);

app.use(express.static(__dirname + "/public"));

// ===== Estado compartilhado =====
let users = [
  { id: 1, username: "admin", password: "admin123", role: "admin" },
  { id: 2, username: "estoquista", password: "1234", role: "estoquista" },
  { id: 3, username: "vendedor", password: "venda", role: "vendedor" }
];

let products = [
  { id: 1, sku: "789000000001", name: "Rojão Trovão", quantity: 100 },
  { id: 2, sku: "789000000002", name: "Morteiro 3 Pol", quantity: 50 },
  { id: 3, sku: "789000000003", name: "Chuva de Prata", quantity: 30 },
  { id: 4, sku: "789000000004", name: "Foguete 12 tiros", quantity: 80 }
];

let movements = [];

// ===== WebSocket =====
io.on("connection", (socket) => {
  console.log("Cliente conectado");

  // envia estado inicial
  socket.emit("init", { users, products, movements });

  socket.on("updateUsers", (newUsers) => {
    users = newUsers;
    io.emit("updateUsers", users);
  });

  socket.on("updateProducts", (newProducts) => {
    products = newProducts;
    io.emit("updateProducts", products);
  });

  socket.on("updateMovements", (newMovs) => {
    movements = newMovs;
    io.emit("updateMovements", movements);
  });

  socket.on("disconnect", () => {
    console.log("Cliente saiu");
  });
});

server.listen(3000, () => {
  console.log("Servidor rodando em http://localhost:3000");
});
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ERP Fogos - Multiusuários</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="/socket.io/socket.io.js"></script>
<style>
/* ... (mantém o CSS anterior) ... */
.edit-box { background:#f9fafb; padding:10px; margin-top:8px; border:1px solid #ddd; border-radius:6px; }
</style>
</head>
<body>
<!-- LOGIN -->
<div id="loginPage" style="display:flex;justify-content:center;align-items:center;height:100vh;">
  <div style="background:#fff;padding:20px;border-radius:8px;max-width:400px;width:100%;">
    <h2>Login ERP</h2>
    <form id="loginForm">
      <input id="username" placeholder="Usuário" required style="width:100%;margin:6px 0;">
      <input id="password" type="password" placeholder="Senha" required style="width:100%;margin:6px 0;">
      <button type="submit" class="btn btn-success" style="width:100%;">Entrar</button>
    </form>
    <div id="errorMessage" style="color:#dc2626;margin-top:8px;"></div>
  </div>
</div>

<!-- SISTEMA -->
<div id="erpSystem" style="display:none;">
  <header>
    <h1>ERP Fogos</h1>
    <div id="currentUserDisplay"></div>
    <button onclick="logout()" class="btn btn-danger" id="logoutBtn" style="display:none;">Sair</button>
  </header>

  <div class="nav-tabs">
    <button class="tab active" onclick="switchTab('dashboard')">Dashboard</button>
    <button class="tab" onclick="switchTab('products')">Produtos</button>
    <button class="tab" onclick="switchTab('movements')">Movimentações</button>
    <button class="tab" onclick="switchTab('scanner')">Scanner</button>
    <button class="tab" onclick="switchTab('users')">Usuários</button>
  </div>

  <div class="content">
    <!-- ... outras abas ... -->

    <!-- USUÁRIOS -->
    <div id="users" class="tab-content" style="display:none;">
      <h3>Usuários</h3>
      <form id="userForm">
        <input id="newUser" placeholder="Usuário" required>
        <input id="newPass" placeholder="Senha" required>
        <select id="newRole"><option value="admin">Admin</option><option value="estoquista">Estoquista</option><option value="vendedor">Vendedor</option></select>
        <button class="btn btn-success">Adicionar</button>
      </form>
      <table id="usersTable"><thead><tr><th>ID</th><th>Usuário</th><th>Papel</th><th>Ações</th></tr></thead><tbody></tbody></table>

      <!-- Caixa de edição -->
      <div id="editUserBox" class="edit-box" style="display:none;">
        <h4>Editar Usuário</h4>
        <input id="editUserName" placeholder="Usuário">
        <input id="editUserPass" placeholder="Nova Senha (opcional)">
        <select id="editUserRole"><option value="admin">Admin</option><option value="estoquista">Estoquista</option><option value="vendedor">Vendedor</option></select>
        <button onclick="saveUserEdit()" class="btn btn-success">Salvar</button>
        <button onclick="cancelUserEdit()" class="btn btn-danger">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<script>
let socket = io();
let users=[], products=[], movements=[];
let currentUser=null;
let editingUserId=null;

/* ===== Login e hierarquia (igual antes) ===== */
// ... (mantém as funções de login, logout, permissões e navegação) ...

/* ===== Usuários ===== */
document.getElementById("userForm").addEventListener("submit",e=>{
  e.preventDefault();
  if(!canManageUsers()){alert("Apenas admin.");return;}
  const id=users.length?Math.max(...users.map(x=>x.id))+1:1;
  users.push({
    id,
    username:document.getElementById("newUser").value,
    password:document.getElementById("newPass").value,
    role:document.getElementById("newRole").value
  });
  socket.emit("updateUsers",users);
  e.target.reset();
});

function delUser(id){
  if(!canManageUsers()){alert("Apenas admin.");return;}
  users=users.filter(u=>u.id!==id);
  socket.emit("updateUsers",users);
}

function editUser(id){
  if(!canManageUsers()){alert("Apenas admin.");return;}
  const u=users.find(x=>x.id===id);
  if(!u) return;
  editingUserId=id;
  document.getElementById("editUserName").value=u.username;
  document.getElementById("editUserPass").value="";
  document.getElementById("editUserRole").value=u.role;
  document.getElementById("editUserBox").style.display="block";
}

function saveUserEdit(){
  const u=users.find(x=>x.id===editingUserId);
  if(!u) return;
  u.username=document.getElementById("editUserName").value;
  const pass=document.getElementById("editUserPass").value;
  if(pass) u.password=pass; // só troca se informado
  u.role=document.getElementById("editUserRole").value;
  socket.emit("updateUsers",users);
  cancelUserEdit();
}

function cancelUserEdit(){
  editingUserId=null;
  document.getElementById("editUserBox").style.display="none";
}

function updateUsers(){
  const tb=document.querySelector("#usersTable tbody");
  tb.innerHTML=users.map(u=>
    `<tr><td>${u.id}</td><td>${u.username}</td><td>${u.role}</td>
    <td>
      ${canManageUsers()?`<button class="btn btn-success" onclick="editUser(${u.id})">Editar</button>`:""}
      ${canManageUsers()?`<button class="btn btn-danger" onclick="delUser(${u.id})">Excluir</button>`:""}
    </td></tr>`
  ).join("");
}

/* ===== Produtos, Movimentações, Scanner, Sync ===== */
// ... (mantém as funções que já passei na versão anterior: updateProducts, updateMovements, scanner, socket.on etc.) ...
</script>
</body>
</html>


