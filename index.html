<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sistema ERP - Multiusuários</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height: 100vh; }
        .login-container { display:flex; justify-content:center; align-items:center; min-height:100vh; padding:20px; }
        .login-box { background:white; padding:30px; border-radius:12px; width:100%; max-width:420px; box-shadow:0 10px 40px rgba(0,0,0,0.25); }
        .login-box h2 { text-align:center; margin-bottom:8px; color:#333; }
        .form-group { margin-bottom:14px; }
        .form-group label { display:block; margin-bottom:6px; color:#444; }
        .form-group input, select { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #e5e7eb; }
        .login-btn { width:100%; padding:12px; border-radius:8px; background:linear-gradient(135deg,#667eea,#764ba2); color:white; border:none; cursor:pointer; font-weight:600; }
        .error-message { margin-top:12px; padding:10px; background:#fee; color:#b91c1c; border-radius:8px; display:none; }
        .error-message.show { display:block; }
        .login-info { margin-top:14px; padding:10px; background:#f0f9ff; border-radius:8px; color:#0b5ed7; font-size:14px; }
        #erpSystem { display:none; padding:20px; }
        .container { max-width:1200px; margin:0 auto; }
        header { background:linear-gradient(135deg,#667eea,#764ba2); color:white; padding:14px 20px; border-radius:10px; display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
        header .left { display:flex; align-items:center; gap:12px; }
        .logo { background:white; color:#667eea; padding:6px 12px; border-radius:6px; font-weight:700; }
        .user-area { display:flex; align-items:center; gap:8px; font-size:14px; }
        .logout-btn { background:#ef4444; border:none; padding:6px 10px; color:white; border-radius:8px; cursor:pointer; }
        .nav-tabs { margin:14px 0; display:flex; gap:8px; flex-wrap:wrap; }
        .tab { padding:10px 16px; border-radius:8px; background:white; border:none; cursor:pointer; }
        .tab.active { background:linear-gradient(135deg,#667eea,#764ba2); color:white; }
        .content { background:white; padding:18px; border-radius:10px; }
        table { width:100%; border-collapse:collapse; margin-top:12px; }
        th, td { padding:10px; border-bottom:1px solid #eee; text-align:left; }
        .btn-danger { background:linear-gradient(135deg,#ef4444,#dc2626); color:white; padding:6px 10px; border-radius:8px; border:none; cursor:pointer; }
        .btn-success { background:linear-gradient(135deg,#10b981,#059669); color:white; padding:6px 10px; border-radius:8px; border:none; cursor:pointer; }
        .badge-warning { background:#fef3c7; padding:4px 8px; border-radius:8px; color:#92400e; }
        .code-display { margin-top:16px; padding:12px; background:#f9fafb; border-radius:8px; text-align:center; }
        .alert { padding:12px; border-radius:8px; margin-bottom:12px; }
        .alert-success { background:#d1fae5; color:#065f46; }
        .alert-danger { background:#fee2e2; color:#991b1b; }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h2>Sistema ERP</h2>
            <p style="text-align:center;color:#666;margin-bottom:12px;">Gestão de Estoque</p>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Usuário</label>
                    <input id="username" type="text" autocomplete="username" required />
                </div>
                <div class="form-group">
                    <label for="password">Senha</label>
                    <input id="password" type="password" autocomplete="current-password" required />
                </div>
                <button class="login-btn" type="submit">Entrar</button>
                <div id="errorMessage" class="error-message"></div>
            </form>
            <div class="login-info">
                <strong>Contas de teste:</strong> admin / admin123 • estoquista / 1234 • vendedor / venda
            </div>
        </div>
    </div>

    <!-- SISTEMA -->
    <div id="erpSystem">
        <div class="container">
            <header>
                <div class="left">
                    <div class="logo">ERP</div>
                    <div><strong>Sistema de Gestão</strong></div>
                </div>
                <div class="user-area">
                    <div id="currentTime"></div>
                    <div id="currentUserDisplay" style="display:flex;align-items:center;gap:8px;"></div>
                    <button id="logoutBtn" class="logout-btn" style="display:none;" onclick="logout()">Sair</button>
                </div>
            </header>

            <div class="nav-tabs" style="margin-top:12px;">
                <button class="tab active" onclick="switchTab('dashboard')">Dashboard</button>
                <button class="tab" onclick="switchTab('products')">Produtos</button>
                <button class="tab" onclick="switchTab('movements')">Movimentações</button>
                <button class="tab" onclick="switchTab('codes')">Códigos</button>
            </div>

            <div class="content">
                <!-- DASHBOARD -->
                <div id="dashboard" class="tab-content active">
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;">
                        <div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:12px;border-radius:8px;">
                            <div style="font-size:20px;" id="totalProducts">0</div>
                            <div>Produtos</div>
                        </div>
                        <div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:12px;border-radius:8px;">
                            <div style="font-size:20px;" id="totalStock">0</div>
                            <div>Estoque</div>
                        </div>
                        <div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:12px;border-radius:8px;">
                            <div style="font-size:20px;" id="totalValue">R$ 0</div>
                            <div>Valor Total</div>
                        </div>
                        <div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:12px;border-radius:8px;">
                            <div style="font-size:20px;" id="todayMovements">0</div>
                            <div>Movimentações Hoje</div>
                        </div>
                    </div>

                    <div style="margin-top:14px;">
                        <h3>Estoque Baixo</h3>
                        <table id="lowStockTable">
                            <thead><tr><th>SKU</th><th>Produto</th><th>Qtd</th><th>Status</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <div style="margin-top:14px;">
                        <h3>Últimas Movimentações</h3>
                        <table id="recentMovements">
                            <thead><tr><th>Data</th><th>Produto</th><th>Tipo</th><th>Qtd</th><th>Usuário</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- PRODUCTS -->
                <div id="products" class="tab-content" style="display:none;">
                    <h3>Cadastrar Produto</h3>
                    <form id="productForm" class="form-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;">
                        <div class="form-group"><label>SKU</label><input id="sku" required /></div>
                        <div class="form-group"><label>Nome</label><input id="name" required /></div>
                        <div class="form-group"><label>Quantidade</label><input id="quantity" type="number" min="0" value="0" required /></div>
                        <div class="form-group"><label>Preço</label><input id="price" type="number" step="0.01" min="0" value="0.00" required /></div>
                        <div class="form-group"><label>Fornecedor</label><input id="supplier" /></div>
                        <div class="form-group"><label>Estoque Mín</label><input id="minStock" type="number" min="0" value="10" /></div>
                        <div style="align-self:end;"><button type="submit" class="btn-success">Cadastrar</button></div>
                    </form>

                    <h3 style="margin-top:12px;">Lista de Produtos</h3>
                    <div style="display:flex;gap:8px;margin-bottom:8px;">
                        <input id="searchProduct" placeholder="Buscar..." oninput="searchProducts()" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e5e7eb;" />
                        <button onclick="exportCSV()" class="btn-success">Exportar</button>
                    </div>
                    <table id="productsTable">
                        <thead><tr><th>ID</th><th>SKU</th><th>Nome</th><th>Qtd</th><th>Preço</th><th>Ações</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- MOVEMENTS -->
                <div id="movements" class="tab-content" style="display:none;">
                    <h3>Registrar Movimentação</h3>
                    <form id="movementForm" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;">
                        <div class="form-group"><label>Produto</label><select id="movProductId" required><option value="">Selecione</option></select></div>
                        <div class="form-group"><label>Tipo</label><select id="movType" required><option value="ENTRADA">Entrada</option><option value="SAIDA">Saída</option></select></div>
                        <div class="form-group"><label>Quantidade</label><input id="movQuantity" type="number" min="1" value="1" required /></div>
                        <div class="form-group"><label>Responsável</label><input id="movUser" required /></div>
                        <div class="form-group"><label>Observações</label><input id="movNotes" /></div>
                        <div style="align-self:end;"><button type="submit" class="btn-success">Registrar</button></div>
                    </form>

                    <h3 style="margin-top:12px;">Histórico</h3>
                    <table id="movementsTable">
                        <thead><tr><th>ID</th><th>Data</th><th>Produto</th><th>Tipo</th><th>Qtd</th><th>Usuário</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- CODES -->
                <div id="codes" class="tab-content" style="display:none;">
                    <h3>Gerar QR e Código de Barras</h3>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;">
                        <div class="form-group"><label>Produto</label><select id="codeProductId"><option value="">Selecione</option></select></div>
                        <div class="form-group"><label>Código Personalizado</label><input id="customCode" /></div>
                        <div style="align-self:end;"><button onclick="generateCodes()" class="btn-success">Gerar</button></div>
                    </div>
                    <div id="codeDisplay" class="code-display" style="display:none;">
                        <h4>QR Code</h4>
                        <div id="qrcode"></div>
                        <h4 style="margin-top:12px;">Código de Barras</h4>
                        <svg id="barcode"></svg>
                        <div style="margin-top:10px;">
                            <button onclick="downloadQR()" class="btn-success">Download QR</button>
                            <button onclick="window.print()" class="btn-success">Imprimir</button>
                        </div>
                    </div>
                </div>

                <div id="alerts"></div>
            </div>
        </div>
    </div>

<script>
/* ======= Usuários ======= */
/* Adicione/edite usuários aqui (senha armazenada como sha256) */
const users = [
    { username: "admin", password: sha256("admin123"), role: "admin" },
    { username: "estoquista", password: sha256("1234"), role: "estoquista" },
    { username: "vendedor", password: sha256("venda"), role: "vendedor" }
];

let currentUser = null;

/* ======= Login ======= */
const loginForm = document.getElementById('loginForm');
const errMsg = document.getElementById('errorMessage');

// Esconder erro ao digitar
document.getElementById('username').addEventListener('input', () => errMsg.classList.remove('show'));
document.getElementById('password').addEventListener('input', () => errMsg.classList.remove('show'));

loginForm.addEventListener('submit', function(e){
    e.preventDefault();
    const user = document.getElementById('username').value.trim();
    const pass = document.getElementById('password').value.trim();

    if (!user || !pass) {
        errMsg.textContent = "Preencha usuário e senha.";
        errMsg.classList.add('show');
        return;
    }

    const found = users.find(u => u.username === user && u.password === sha256(pass));
    if (!found) {
        errMsg.textContent = "Usuário ou senha incorretos.";
        errMsg.classList.add('show');
        return;
    }

    // Login OK
    currentUser = found;
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('erpSystem').style.display = 'block';
    document.getElementById('logoutBtn').style.display = 'inline-block';

    // mostra usuário no header
    const userDisplay = document.getElementById('currentUserDisplay');
    userDisplay.innerHTML = `👤 <strong>${currentUser.username}</strong> (${currentUser.role})`;

    init();
    startClock();
    showAlert(`Bem-vindo, ${currentUser.username}!`, 'success');
});

/* Logout */
function logout() {
    if (!confirm('Deseja sair?')) return;
    currentUser = null;
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('erpSystem').style.display = 'none';
    document.getElementById('currentUserDisplay').innerHTML = '';
    document.getElementById('logoutBtn').style.display = 'none';
}

/* ======= Sistema (estado local) ======= */
let products = [];
let movements = [];

function init(){
    // dados iniciais (pode carregar de backend se quiser)
    products = [
        {id:1, sku:'7891234567890', name:'Rojão Trovão', quantity:150, price:12.50, supplier:'Fogos SP', minStock:20},
        {id:2, sku:'7891234567891', name:'Morteiro 3 Pol', quantity:45, price:85.00, supplier:'Pirotecnia BR', minStock:10},
        {id:3, sku:'7891234567892', name:'Chuva de Prata', quantity:8, price:65.00, supplier:'Fogos MG', minStock:15}
    ];
    const now = new Date();
    movements = [
        {id:1, productId:1, type:'ENTRADA', quantity:50, user:'João', date:new Date(now - 86400000), notes:'Inicial'},
        {id:2, productId:2, type:'SAIDA', quantity:5, user:'Maria', date:new Date(now - 43200000), notes:'Venda'}
    ];
    update();
}

/* ======= Atualizações de UI ======= */
function update(){
    updateDashboard();
    updateProducts();
    updateMovements();
    updateSelects();
}

function updateDashboard(){
    document.getElementById('totalProducts').textContent = products.length;
    document.getElementById('totalStock').textContent = products.reduce((s,p)=>s+p.quantity,0);
    document.getElementById('totalValue').textContent = fmt(products.reduce((s,p)=>s+(p.quantity*p.price),0));
    const today = new Date().toDateString();
    document.getElementById('todayMovements').textContent = movements.filter(m=>m.date && m.date.toDateString()===today).length;

    const low = products.filter(p=>p.quantity <= (p.minStock||10));
    const tbodyLow = document.querySelector('#lowStockTable tbody');
    tbodyLow.innerHTML = low.length === 0 ? '<tr><td colspan="4" style="text-align:center;color:#777">Nenhum produto</td></tr>' :
        low.map(p=>`<tr><td>${p.sku}</td><td>${p.name}</td><td>${p.quantity}</td><td><span class="badge-warning">Baixo</span></td></tr>`).join('');

    const rec = movements.slice(-10).reverse();
    const tbodyRec = document.querySelector('#recentMovements tbody');
    tbodyRec.innerHTML = rec.length === 0 ? '<tr><td colspan="5" style="text-align:center;color:#777">Nenhuma movimentação</td></tr>' :
        rec.map(m=> {
            const p = products.find(pr=>pr.id===m.productId);
            return `<tr><td>${fmtDate(m.date)}</td><td>${p? p.name : 'N/A'}</td><td>${m.type}</td><td>${m.quantity}</td><td>${m.user}</td></tr>`;
        }).join('');
}

function updateProducts(){
    const tbody = document.querySelector('#productsTable tbody');
    if (products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#777">Nenhum produto</td></tr>';
        return;
    }
    tbody.innerHTML = products.map(p=>`
        <tr>
            <td>${p.id}</td>
            <td>${p.sku}</td>
            <td>${p.name}</td>
            <td>${p.quantity}</td>
            <td>${fmt(p.price)}</td>
            <td>
                ${currentUser && currentUser.role === 'admin' 
                    ? `<button class="btn-danger" onclick="delProduct(${p.id})">Excluir</button>`
                    : `<button class="btn-danger" disabled title="Apenas admin pode excluir">Excluir</button>`
                }
            </td>
        </tr>
    `).join('');
}

function updateMovements(){
    const tbody = document.querySelector('#movementsTable tbody');
    if (movements.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#777">Nenhuma movimentação</td></tr>';
        return;
    }
    tbody.innerHTML = movements.slice().reverse().map(m=>{
        const p = products.find(pr=>pr.id===m.productId);
        return `<tr>
            <td>${m.id}</td>
            <td>${fmtDate(m.date)}</td>
            <td>${p? p.name : 'N/A'}</td>
            <td>${m.type}</td>
            <td>${m.quantity}</td>
            <td>${m.user}</td>
        </tr>`;
    }).join('');
}

function updateSelects(){
    ['movProductId','codeProductId'].forEach(id=>{
        const sel = document.getElementById(id);
        if (!sel) return;
        const cur = sel.value;
        sel.innerHTML = '<option value="">Selecione</option>' + products.map(p=>`<option value="${p.id}">${p.name} (${p.sku})</option>`).join('');
        if (cur) sel.value = cur;
    });
}

/* ======= Navegação de abas ======= */
function switchTab(tab){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
    // ativa o botão clicado
    // event target pode não existir quando chamado por código, então identifico botão pela label
    const btns = Array.from(document.querySelectorAll('.tab'));
    btns.forEach(b=>{ if (b.textContent.trim().toLowerCase()===tab.toLowerCase()) b.classList.add('active');});
    // mas como os textos são Dashboard/Produtos..., vou mapear diretamente:
    if (tab === 'dashboard') {
        document.querySelectorAll('.tab')[0].classList.add('active');
        document.getElementById('dashboard').style.display = 'block';
    } else if (tab === 'products') {
        document.querySelectorAll('.tab')[1].classList.add('active');
        document.getElementById('products').style.display = 'block';
    } else if (tab === 'movements') {
        document.querySelectorAll('.tab')[2].classList.add('active');
        document.getElementById('movements').style.display = 'block';
    } else if (tab === 'codes') {
        document.querySelectorAll('.tab')[3].classList.add('active');
        document.getElementById('codes').style.display = 'block';
    }
}

/* ======= Formularios ======= */
document.getElementById('productForm').addEventListener('submit', function(e){
    e.preventDefault();
    const sku = document.getElementById('sku').value.trim();
    const name = document.getElementById('name').value.trim();
    const quantity = parseInt(document.getElementById('quantity').value) || 0;
    const price = parseFloat(document.getElementById('price').value) || 0;
    const supplier = document.getElementById('supplier').value.trim();
    const minStock = parseInt(document.getElementById('minStock').value) || 10;

    if (!sku || !name) {
        showAlert('Preencha SKU e Nome', 'danger');
        return;
    }

    if (products.find(p=>p.sku === sku)) {
        showAlert('SKU já existe', 'danger');
        return;
    }

    const id = products.length > 0 ? Math.max(...products.map(p=>p.id)) + 1 : 1;
    products.push({ id, sku, name, quantity, price, supplier, minStock });
    update();
    showAlert('Produto cadastrado!', 'success');
    this.reset();
});

document.getElementById('movementForm').addEventListener('submit', function(e){
    e.preventDefault();
    const prodId = parseInt(document.getElementById('movProductId').value);
    const type = document.getElementById('movType').value;
    const qty = parseInt(document.getElementById('movQuantity').value) || 0;
    const user = document.getElementById('movUser').value.trim() || (currentUser ? currentUser.username : 'Sistema');

    const prod = products.find(p=>p.id === prodId);
    if (!prod) { showAlert('Produto não encontrado', 'danger'); return; }
    if (type === 'SAIDA' && prod.quantity < qty) { showAlert('Quantidade insuficiente', 'danger'); return; }

    const id = movements.length > 0 ? Math.max(...movements.map(m=>m.id)) + 1 : 1;
    const mv = { id, productId: prodId, type, quantity: qty, user, date: new Date(), notes: document.getElementById('movNotes').value || '' };
    movements.push(mv);
    prod.quantity += (type === 'ENTRADA' ? qty : -qty);
    update();
    showAlert('Movimentação registrada!', 'success');
    this.reset();
});

/* Exclusão - somente admin */
function delProduct(id){
    if (!currentUser || currentUser.role !== 'admin') { showAlert('Apenas admin pode excluir produtos', 'danger'); return; }
    if (!confirm('Excluir produto?')) return;
    products = products.filter(p=>p.id !== id);
    movements = movements.filter(m=>m.productId !== id);
    update();
    showAlert('Produto excluído', 'success');
}

/* Busca */
function searchProducts(){
    const term = document.getElementById('searchProduct').value.toLowerCase();
    document.querySelectorAll('#productsTable tbody tr').forEach(row=>{
        row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
    });
}

/* Gerar códigos */
function generateCodes(){
    const prodId = document.getElementById('codeProductId').value;
    const custom = document.getElementById('customCode').value.trim();
    let code = custom || '';
    if (!code && prodId) {
        const p = products.find(pr=>pr.id == prodId);
        if (p) code = p.sku;
    }
    if (!code) { showAlert('Selecione um produto ou digite um código', 'danger'); return; }
    document.getElementById('codeDisplay').style.display = 'block';
    document.getElementById('qrcode').innerHTML = '';
    new QRCode(document.getElementById('qrcode'), { text: code, width:200, height:200 });
    try {
        JsBarcode('#barcode', code, { format: 'CODE128', width:2, height:80, displayValue:true });
    } catch (e) {
        showAlert('Erro ao gerar código de barras', 'danger');
    }
}

/* Download QR */
function downloadQR(){
    const canvas = document.querySelector('#qrcode canvas');
    if (!canvas) { showAlert('QR não disponível', 'danger'); return; }
    const link = document.createElement('a');
    link.download = 'qrcode.png';
    link.href = canvas.toDataURL();
    link.click();
}

/* Export CSV */
function exportCSV(){
    const csv = 'ID;SKU;Nome;Qtd;Preço;Fornecedor\n' + products.map(p=>`${p.id};${p.sku};${p.name};${p.quantity};${p.price};${p.supplier || ''}`).join('\n');
    const blob = new Blob([csv], { type:'text/csv' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'produtos.csv';
    link.click();
    showAlert('Exportado!', 'success');
}

/* Alerts */
function showAlert(msg, type){
    const container = document.getElementById('alerts');
    const div = document.createElement('div');
    div.className = `alert ${type === 'success' ? 'alert-success' : 'alert-danger'}`;
    div.textContent = msg;
    container.appendChild(div);
    setTimeout(()=> div.remove(), 3500);
}

/* Utils */
function fmt(v){ return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v); }
function fmtDate(d){ 
    if (!d) return '';
    const dt = new Date(d);
    return new Intl.DateTimeFormat('pt-BR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}).format(dt);
}

/* Relógio */
let clockInterval = null;
function startClock(){
    document.getElementById('currentTime').textContent = new Date().toLocaleString('pt-BR');
    if (clockInterval) clearInterval(clockInterval);
    clockInterval = setInterval(()=> document.getElementById('currentTime').textContent = new Date().toLocaleString('pt-BR'), 1000);
}

/* Inicializa selects e tabelas ao carregar a página (caso já logado manualmente) */
window.addEventListener('load', ()=> {
    // nada por enquanto; login aciona init()
});
</script>
</body>
</html>
